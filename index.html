<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fitness Challenge Tracker ‚Äî Live (Firestore only)</title>

    <!-- Firebase (compat builds for simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
      :root{
        --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
        --accent:#22c55e; --border:#1f2937;
      }
      *{box-sizing:border-box}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:var(--bg);color:var(--text)}
      .wrap{max-width:720px;margin:32px auto;padding:0 16px}
      h1{font-size:1.4rem;margin:0 0 12px}
      p.sub{color:var(--muted);margin:0 0 18px;font-size:.9rem}

      .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}

      .form-grid{display:flex;flex-wrap:wrap;gap:8px}
      .form-grid input[type="text"],
      .form-grid input[type="number"],
      .form-grid input[type="file"]{
        flex:1 1 120px;padding:8px 10px;border-radius:8px;border:1px solid var(--border);
        background:#0b1220;color:var(--text);font-size:.9rem;
      }

      .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
      button{border:1px solid var(--border);background:#0b1220;color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:.9rem}
      button.primary{background:var(--accent);border-color:#16a34a;color:#041207;font-weight:600}

      /* ===== Clean / professional table styling ===== */
      table{width:100%;border-collapse:collapse;margin-top:16px;font-size:.9rem}
      thead{background:#1e293b;color:#e5e7eb;text-transform:uppercase;letter-spacing:.5px}
      thead th{padding:12px 10px;border-bottom:2px solid #334155}
      th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px;vertical-align:middle}
      tbody tr:nth-child(odd){background:#0f172a}
      tbody tr:nth-child(even){background:#111827}
      tbody tr:hover{background:#1e293b;transition:background .2s ease}

      /* Subtle top-3 tints */
      tr.top1{background:rgba(34,197,94,.15)}
      tr.top2{background:rgba(148,163,184,.15)}
      tr.top3{background:rgba(245,158,11,.15)}

      /* Numbers right-aligned from col 3+ */
      td:nth-child(n+3), th:nth-child(n+3){text-align:right}

      /* Name ellipsis */
      td:nth-child(2), th:nth-child(2){white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

      /* Photo */
      img.avatar{width:36px;height:36px;object-fit:cover;border-radius:6px;border:1px solid #334155}

      /* Notes / status */
      .note{font-size:.8rem;color:var(--muted);margin-top:10px}
      .error{color:#fca5a5}.success{color:#86efac}

      /* Mobile: hide less important columns (Goal, % to Goal) */
      @media (max-width:480px){
        td:nth-child(5),th:nth-child(5),
        td:nth-child(7),th:nth-child(7){display:none}
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>5 Weeks Challenge üèãÔ∏è Fitness Challenge Tracker (Live)</h1>
      <p class="sub">
        Add <strong>Name</strong>, <strong>Start</strong>, <strong>Current</strong>, <strong>Goal</strong>, and an optional small
        <strong>Photo</strong>. Leaderboard sorts by <strong>% to Goal</strong> (works for gaining or losing).
      </p>

      <div class="card">
        <div class="form-grid">
          <input id="name" type="text" placeholder="Name" />
          <input id="start" type="number" placeholder="Starting" step="0.1" />
          <input id="current" type="number" placeholder="Current" step="0.1" />
          <input id="goal" type="number" placeholder="Goal" step="0.1" />
          <input id="photo" type="file" accept="image/*" />
        </div>

        <div class="actions">
          <button class="primary" id="addBtn">Add / Update</button>
          <button class="secondary" id="resetBtn">Reset All</button>
          <button class="secondary" id="exportBtn">Export CSV</button>
        </div>

        <p id="msg" class="note"></p>

        <table>
          <thead>
            <tr>
              <th>Photo</th>
              <th>Name</th>
              <th>Start</th>
              <th>Current</th>
              <th>Goal</th>
              <th>Change</th><!-- was: Lost -->
              <th>% to Goal</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <p class="note">
          Tip: Use short names and small photos. Images are stored as text (Base64) in Firestore; each document should stay under ~1 MB.
        </p>
      </div>
    </div>

    <script>
      /* ===================== Firebase ===================== */
      const firebaseConfig = {
        apiKey: "AIzaSyDHnlcNDXx9ptnkNZvpppnxBoob3-411E0",
        authDomain: "weekschallengeapp.firebaseapp.com",
        projectId: "weekschallengeapp",
        storageBucket: "weekschallengeapp.appspot.com",
        messagingSenderId: "1001371655859",
        appId: "1:1001371655859:web:437a47d7bf3765e7179ac6"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const participantsRef = db.collection("participants");

      /* ===================== UI helpers ===================== */
      const msgEl = document.getElementById("msg");
      function showMsg(text, kind = "info") {
        msgEl.textContent = text;
        msgEl.className = "note " + (kind === "error" ? "error" : kind === "success" ? "success" : "");
      }

      function clearInputs() {
        document.getElementById("name").value = "";
        document.getElementById("start").value = "";
        document.getElementById("current").value = "";
        document.getElementById("goal").value = "";
        document.getElementById("photo").value = "";
      }

      // Resize image to a small Base64 to keep docs light
      function fileToSmallDataURL(file, maxSize = 160, quality = 0.75) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          const reader = new FileReader();
          reader.onload = (e) => { img.src = e.target.result; };
          reader.onerror = reject;
          img.onload = () => {
            const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
            const w = Math.round(img.width * scale), h = Math.round(img.height * scale);
            const canvas = document.createElement("canvas");
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);
            try { resolve(canvas.toDataURL("image/jpeg", quality)); }
            catch (e) { reject(e); }
          };
          img.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      /* ===================== Add/Update ===================== */
      document.getElementById("addBtn").addEventListener("click", addOrUpdate);
      async function addOrUpdate() {
        const name = document.getElementById("name").value.trim();
        const start = parseFloat(document.getElementById("start").value);
        const current = parseFloat(document.getElementById("current").value);
        const goal = parseFloat(document.getElementById("goal").value);
        const photoInput = document.getElementById("photo");

        if (!name || isNaN(start) || isNaN(current) || isNaN(goal)) {
          showMsg("Please fill Name, Start, Current, Goal correctly.", "error");
          return;
        }

        showMsg("Saving‚Ä¶");

        try {
          let photoDataUrl = null;
          if (photoInput.files && photoInput.files[0]) {
            try { photoDataUrl = await fileToSmallDataURL(photoInput.files[0], 160, 0.75); }
            catch (e) { console.warn("Photo compression failed; proceeding without photo.", e); }
          }

          await participantsRef.doc(name).set(
            { start, current, goal, ...(photoDataUrl ? { photo: photoDataUrl } : {}) },
            { merge: true }
          );

          showMsg("Saved!", "success");
          clearInputs();
        } catch (err) {
          console.error(err);
          showMsg("Error saving participant: " + (err.message || err.code || err), "error");
        }
      }

      /* ===================== Reset All ===================== */
      document.getElementById("resetBtn").addEventListener("click", resetAll);
      async function resetAll() {
        if (!confirm("Are you sure you want to delete ALL participants?")) return;
        try {
          const snap = await participantsRef.get();
          const batch = db.batch();
          snap.forEach((doc) => batch.delete(doc.ref));
          await batch.commit();
          clearInputs();
          showMsg("All data cleared.", "success");
        } catch (err) {
          console.error(err);
          showMsg("Reset error: " + (err.message || err.code || err), "error");
        }
      }

      /* ===== Universal progress (works for gainers & losers) ===== */
      function calcProgress(start, current, goal) {
        const s = Number(start) || 0;
        const c = Number(current) || 0;
        const g = Number(goal) || 0;

        const change = +(c - s).toFixed(1);            // +gain / -loss
        const totalNeeded = Math.abs(g - s);
        const progress = Math.min(Math.abs(c - s), totalNeeded);
        const percentToGoal = totalNeeded > 0 ? +((progress / totalNeeded) * 100).toFixed(1) : 0;

        return { change, percentToGoal };
      }

      /* ===================== Render & Realtime ===================== */
      const tbody = document.getElementById("tbody");
      let latestData = [];

      function renderTable(list) {
        // Sort by % to Goal (desc)
        const sorted = [...list].sort((a, b) => {
          const A = calcProgress(a.start, a.current, a.goal).percentToGoal;
          const B = calcProgress(b.start, b.current, b.goal).percentToGoal;
          return B - A;
        });

        tbody.innerHTML = "";
        sorted.forEach((p, idx) => {
          const { change, percentToGoal } = calcProgress(p.start, p.current, p.goal);
          const tr = document.createElement("tr");
          if (idx === 0) tr.className = "top1";
          else if (idx === 1) tr.className = "top2";
          else if (idx === 2) tr.className = "top3";

          tr.innerHTML = `
            <td>${p.photo ? `<img class="avatar" src="${p.photo}" alt="${p.name}" />` : ""}</td>
            <td>${p.name}</td>
            <td>${p.start ?? ""}</td>
            <td>${p.current ?? ""}</td>
            <td>${p.goal ?? ""}</td>
            <td>${change > 0 ? "+" + change : change}</td>
            <td>${percentToGoal}%</td>
          `;
          tbody.appendChild(tr);
        });
      }

      participantsRef.onSnapshot(
        (snapshot) => {
          const list = [];
          snapshot.forEach((doc) => list.push({ name: doc.id, ...doc.data() }));
          latestData = list;
          renderTable(list);
        },
        (err) => {
          console.error("Realtime error:", err);
          showMsg("Realtime error: " + (err.message || err.code || err), "error");
        }
      );

      /* ===================== CSV export ===================== */
      document.getElementById("exportBtn").addEventListener("click", () => {
        if (!latestData.length) { showMsg("No data to export.", "error"); return; }

        let csv = "Name,Start,Current,Goal,Change,% to Goal\n";
        latestData.forEach((p) => {
          const { change, percentToGoal } = calcProgress(p.start, p.current, p.goal);
          csv += `${p.name},${p.start ?? ""},${p.current ?? ""},${p.goal ?? ""},${change},${percentToGoal}%\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "fitness-challenge.csv"; a.click();
        URL.revokeObjectURL(url);
        showMsg("CSV exported!", "success");
      });
    </script>
  </body>
</html>
