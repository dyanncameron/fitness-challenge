<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fitness Challenge Tracker ‚Äî Live (Firestore only)</title>

    <!-- Firebase (compat builds for simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
      /* ====== Base colors and variables ====== */
      :root{
        --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
        --accent:#22c55e; --border:#1f2937;
      }

      /* ====== General layout ====== */
      *{box-sizing:border-box}
      body{
        font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
        margin:0; background:var(--bg); color:var(--text)
      }
      .wrap{max-width:720px;margin:32px auto;padding:0 16px}
      h1{font-size:1.4rem;margin:0 0 12px}
      p.sub{color:var(--muted);margin:0 0 18px;font-size:.9rem}

      /* ====== Card wrapper ====== */
      .card{
        background:var(--card); border:1px solid var(--border);
        border-radius:12px; padding:16px
      }

      /* ====== Form styling ====== */
      .form-grid{display:flex;flex-wrap:wrap;gap:8px}
      .form-grid input[type="text"],
      .form-grid input[type="number"],
      .form-grid input[type="file"]{
        flex:1 1 120px; padding:8px 10px; border-radius:8px; border:1px solid var(--border);
        background:#0b1220; color:var(--text); font-size:.9rem;
      }

      /* ====== Buttons ====== */
      .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
      button{
        border:1px solid var(--border); background:#0b1220; color:var(--text);
        padding:8px 12px; border-radius:8px; cursor:pointer; font-size:.9rem
      }
      button.primary{background:var(--accent);border-color:#16a34a;color:#041207;font-weight:600}

      /* ====== Table styling ====== */
      table{width:100%;border-collapse:collapse;margin-top:16px;font-size:.9rem}
      thead{background:#1e293b;color:#e5e7eb;text-transform:uppercase;letter-spacing:.5px}
      thead th{padding:12px 10px;border-bottom:2px solid #334155}
      th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px;vertical-align:middle}
      tbody tr:nth-child(odd){background:#0f172a}
      tbody tr:nth-child(even){background:#111827}
      tbody tr:hover{background:#1e293b;transition:background .2s ease}

      /* Highlight top 3 */
      tr.top1{background:rgba(34,197,94,.15)}
      tr.top2{background:rgba(148,163,184,.15)}
      tr.top3{background:rgba(245,158,11,.15)}

      td:nth-child(n+3), th:nth-child(n+3){text-align:right}
      td:nth-child(2), th:nth-child(2){white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      img.avatar{width:36px;height:36px;object-fit:cover;border-radius:6px;border:1px solid #334155}

      /* Notes + success/error */
      .note{font-size:.8rem;color:var(--muted);margin-top:10px}
      .error{color:#fca5a5}.success{color:#86efac}

      /* ====== Progress badges (colors for % to Goal) ====== */
      .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600;border:1px solid #1f2937}
      .badge.good{background:rgba(34,197,94,.12);color:#86efac}
      .badge.bad {background:rgba(239,68,68,.12);color:#fca5a5}
      .badge.hit {background:rgba(245,158,11,.12);color:#fcd34d}

      /* ====== Mobile view: stacked cards instead of table ====== */
      @media (max-width:600px){
        thead{position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden;}
        table, thead, tbody, th, td, tr{display:block; width:100%}
        tbody tr{background:#1f2937; border:1px solid #334155; border-radius:10px; padding:10px; margin:12px 0;}
        td{border:0; padding:8px 6px; display:flex; justify-content:space-between; align-items:center; gap:12px;}
        td::before{content:attr(data-label); color:#94a3b8; font-weight:600; margin-right:12px;}
        td.photo{ justify-content:center; margin-bottom:8px; }
        td.photo::before{ content:"" }
        img.avatar{ width:64px; height:64px; border-radius:50%; display:block; }
        .actions button{ width:100% }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>5 Weeks Challenge üèãÔ∏è Fitness Challenge Tracker (Live)</h1>
      <p class="sub">Leaderboard sorts by <strong>% to Goal</strong> (works for weight gain or loss).</p>

      <!-- ===== Card container with form and table ===== -->
      <div class="card">
        <!-- Input form -->
        <div class="form-grid">
          <input id="name" type="text" placeholder="Name" />
          <input id="start" type="number" placeholder="Starting" step="0.1" />
          <input id="current" type="number" placeholder="Current" step="0.1" />
          <input id="goal" type="number" placeholder="Goal" step="0.1" />
          <input id="photo" type="file" accept="image/*" />
        </div>

        <!-- Buttons for actions -->
        <div class="actions">
          <button class="primary" id="addBtn">Add / Update</button>
          <button class="secondary" id="resetBtn">Reset All</button>
          <button class="secondary" id="exportBtn">Export CSV</button>
        </div>

        <p id="msg" class="note"></p>

        <!-- Leaderboard table -->
        <table>
          <thead>
            <tr>
              <th>Photo</th><th>Name</th><th>Start</th><th>Current</th>
              <th>Goal</th><th>Change</th><th>% to Goal</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      /* ====== Firebase config & init ====== */
      const firebaseConfig = { /* your firebase keys here */ };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const participantsRef = db.collection("participants");

      /* ====== UI helper functions ====== */
      const msgEl = document.getElementById("msg");
      function showMsg(text, kind="info"){
        msgEl.textContent = text;
        msgEl.className = "note " + (kind==="error"?"error": kind==="success"?"success":"");
      }
      function clearInputs(){
        document.getElementById("name").value="";
        document.getElementById("start").value="";
        document.getElementById("current").value="";
        document.getElementById("goal").value="";
        document.getElementById("photo").value="";
      }
      // Resize image file to a small Base64 (saves space in Firestore)
      function fileToSmallDataURL(file,maxSize=160,quality=0.75){ ... }

      /* ====== Progress calculation ====== */
      // Raw % to goal (positive if moving toward, negative if moving away)
      function percentToGoal(start,current,goal){
        const s=Number(start)||0, c=Number(current)||0, g=Number(goal)||0;
        const denom = g-s;
        if(denom===0) return c===s?100:0;
        return ((c-s)/denom)*100;
      }
      // Decide label + badge color
      function progressView(start,current,goal){
        const pct=percentToGoal(start,current,goal);
        const remaining = goal-current;
        const absRemain = Math.abs(remaining).toFixed(1);
        if(pct>=100){
          const past=Math.abs(current-goal).toFixed(1);
          return { text:`${pct.toFixed(1)}% ‚Äî goal met üéâ | ${past}kg past goal`, badge:"hit", pct };
        }
        if(pct<0){
          return { text:`${Math.abs(pct).toFixed(1)}% away from goal ‚ùå | ${absRemain}kg off`, badge:"bad", pct };
        }
        return { text:`${pct.toFixed(1)}% toward goal ‚úÖ | ${absRemain}kg left`, badge:"good", pct };
      }
      // Change in weight with sign
      function signedChange(start,current){
        const d=(Number(current)||0)-(Number(start)||0);
        return (d>=0?"+":"")+d.toFixed(1);
      }

      /* ====== Add / Update participant ====== */
      document.getElementById("addBtn").addEventListener("click", addOrUpdate);
      async function addOrUpdate(){ ... } // saves to Firestore

      /* ====== Reset all participants ====== */
      document.getElementById("resetBtn").addEventListener("click", resetAll);
      async function resetAll(){ ... } // deletes all docs

      /* ====== Render leaderboard in realtime ====== */
      const tbody=document.getElementById("tbody");
      let latestData=[];
      function renderTable(list){
        // Sort participants by % to goal (higher first)
        const sorted=[...list].sort((a,b)=>progressView(b.start,b.current,b.goal).pct - progressView(a.start,a.current,a.goal).pct);
        tbody.innerHTML="";
        sorted.forEach((p,idx)=>{
          const {text,badge}=progressView(p.start,p.current,p.goal);
          const tr=document.createElement("tr");
          if(idx===0) tr.className="top1"; else if(idx===1) tr.className="top2"; else if(idx===2) tr.className="top3";
          tr.innerHTML=`
            <td class="photo">${p.photo?`<img class="avatar" src="${p.photo}">`:""}</td>
            <td>${p.name}</td>
            <td>${p.start??""}</td>
            <td>${p.current??""}</td>
            <td>${p.goal??""}</td>
            <td>${signedChange(p.start,p.current)}</td>
            <td><span class="badge ${badge}">${text}</span></td>
          `;
          tbody.appendChild(tr);
        });
      }
      participantsRef.onSnapshot((snap)=>{
        const list=[]; snap.forEach(doc=>list.push({name:doc.id,...doc.data()}));
        latestData=list; renderTable(list);
      });

      /* ====== Export CSV ====== */
      document.getElementById("exportBtn").addEventListener("click",()=>{
        if(!latestData.length){showMsg("No data","error"); return;}
        let csv="Name,Start,Current,Goal,Change,% to Goal\n";
        latestData.forEach(p=>{
          const pct=progressView(p.start,p.current,p.goal).pct.toFixed(1);
          const chg=signedChange(p.start,p.current);
          csv+=`${p.name},${p.start},${p.current},${p.goal},${chg},${pct}%\n`;
        });
        const blob=new Blob([csv],{type:"text/csv"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url; a.download="fitness-challenge.csv"; a.click();
        URL.revokeObjectURL(url);
        showMsg("CSV exported!","success");
      });
    </script>
  </body>
</html>
